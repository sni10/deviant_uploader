### Админ-панель DeviantArt uploader (MVP)

Bounded context: **photomanager**.

Этот документ описывает, как запустить HTTP‑слой на FastAPI и пользоваться
минимальной админ‑панелью (`/admin`) для планирования и запуска загрузок.

---

### 1. Предварительные условия

1. Python 3.10 в активированном venv.
2. Установлены зависимости проекта:

   ```powershell
   pip install -r requirements.txt
   ```

3. Настроен `.env` (см. основной README):
   - `DA_CLIENT_ID`, `DA_CLIENT_SECRET` — обязательны;
   - опционально: `UPLOAD_DIR`, `DONE_DIR`, `DATABASE_PATH`, `LOG_*`.

4. В папке `upload/` (или той, что указана в `UPLOAD_DIR`) лежат изображения
   поддерживаемых форматов: `jpg`, `jpeg`, `png`, `gif`, `bmp`.

---

### 2. Запуск админ‑API

1. Перейти в корень проекта (`deviant/`).
2. Запустить FastAPI‑приложение через uvicorn:

   ```powershell
   uvicorn src.service.admin_api:app --reload
   ```

3. По умолчанию сервер поднимется на `http://localhost:8000`.

Ключевые эндпоинты (используются UI):

- `GET  /api/uploads/candidates` — список файлов‑кандидатов из `UPLOAD_DIR`;
- `POST /api/uploads/plan`       — сохранение настроек для файлов;
- `POST /api/uploads/run`        — запуск загрузки запланированных девиаций;
- `GET  /upload/{filename}`      — отдача файла для превью в UI.

---

### 3. Открытие UI и общий сценарий

1. После старта uvicorn открыть в браузере:

   - `http://localhost:8000/admin/`

2. Страница загружает список кандидатов через `/api/uploads/candidates` и
   показывает таблицу:

   - превью файла;
   - имя файла;
   - редактируемый заголовок (`title`);
   - два флага режима загрузки:
     - **Publish immediately** (`publish_immediately`);
     - **Stash only** (`stash_only`).

3. Флаги **взаимоисключаемы**:

   - при выборе "Stash only" снимается "Publish immediately";
   - при включении "Publish immediately" снимается "Stash only".

4. Типовой workflow:

   1. Зайти на `/admin/`, убедиться, что видны все нужные файлы.
   2. При необходимости поправить заголовки и режимы загрузки в таблице.
   3. Нажать **Save plan** — настройки сохранятся в PostgreSQL (таблица
      `deviations`), статусы будут сброшены в `NEW`.
   4. Нажать **Run planned uploads** — сервис выполнит загрузку всех
      девиаций со статусом `NEW` с учётом выбранных флагов.

5. После запуска загрузки:

   - элементы, успешно загруженные (stash‑only или опубликованные), будут
     перенесены в папку `DONE_DIR` (по умолчанию `upload/done`).
   - статистика по запуску возвращается JSON‑ответом `/api/uploads/run` и
     кратко показывается в статусной строке UI.

---

### 4. Поведение флагов загрузки

- `publish_immediately = True`, `stash_only = False`  
  Файл заливается в Stash, затем публикуется на DeviantArt. После успеха
  статус девиации становится `DONE`, файл переносится в `DONE_DIR`.

- `stash_only = True`, `publish_immediately = False`  
  Файл заливается только в Stash, без публикации. Статус также становится
  `DONE`, файл переезжает в `DONE_DIR`.

Если оба флага выключены, текущая версия UI всё равно гарантирует, что будет
выбран один из сценариев (взаимоисключение реализовано на стороне клиента).

---

### 5. Типичные проблемы

1. **Пустой список файлов**
   - Проверьте, что `UPLOAD_DIR` указывает на реальную папку;
   - убедитесь, что в ней лежат файлы c поддерживаемыми расширениями.

2. **Ошибки аутентификации DeviantArt**
   - Перепроверьте `DA_CLIENT_ID` и `DA_CLIENT_SECRET` в `.env`;
   - при необходимости перезапустите основной OAuth‑флоу (см. `fetch_user.py`).

3. **Ошибки БД**
   - Посмотрите логи в `logs/app.log`;
   - убедитесь, что директория `data/` доступна для записи.
